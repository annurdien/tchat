name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.0'
    
    - name: Display Swift version
      run: swift --version
    
    - name: Build project
      run: make build
    
    - name: Build release
      run: make build-release
    
    - name: Check binary exists
      run: |
        ls -lh .build/debug/tchat
        ls -lh .build/release/tchat
    
    - name: Test help command
      run: .build/debug/tchat || true
    
    - name: Test server start (timeout)
      run: |
        timeout 5s .build/debug/tchat server 9999 || true
        echo "Server test completed"

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Display Swift version
      run: swift --version
    
    - name: Build project
      run: make build
    
    - name: Build release
      run: make build-release
    
    - name: Check binary exists
      run: |
        ls -lh .build/debug/tchat
        ls -lh .build/release/tchat
    
    - name: Test help command
      run: .build/debug/tchat || true
    
    - name: Test server start (timeout)
      run: |
        timeout 5s .build/debug/tchat server 9999 || true
        echo "Server test completed"
